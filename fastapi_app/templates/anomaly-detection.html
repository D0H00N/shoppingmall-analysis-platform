<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ì´ìƒ ê°ì§€ ë¦¬ë·° ë¶„ì„</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels"></script>
  <style>
    body { 
      font-family: Arial, sans-serif; 
      text-align: center; 
      background: #f8f9fa;
    }
    .container { 
      width: 90%; 
      margin: auto; 
      padding: 20px;
    }
    .title { 
      font-size: 26px; 
      font-weight: bold; 
      margin-bottom: 20px; 
      color: #333; 
    }
    .chart-container { display: flex; justify-content: center; gap: 20px; margin-top: 20px; flex-wrap: wrap; }
    
    /* âœ… ê·¸ë˜í”„ í¬ê¸° í†µì¼ */
    .chart-container { display: flex; justify-content: center; gap: 10px; margin-top: 10px; flex-wrap: wrap; }
    .chart-box {
    width: 200px;
    height: 200px;
}
    .bar-chart-box { width: 400px; height: 200px; }
    .chart-group {
      display: flex;
      justify-content: center;
      align-items: center;
      flex-wrap: wrap;
      gap: 20px;
      margin-top: 20px;
    }
    .bar-chart-box, .radar-chart-box {
    width: 400px;
    height: 200px;
}   
    /* âœ… ë²„íŠ¼ ìŠ¤íƒ€ì¼ ê°œì„  */
    .toggle-btn {
      padding: 10px 20px;
      margin: 10px;
      background: #007BFF;
      color: white;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      font-size: 14px;
      transition: background 0.2s;
    }
    .toggle-btn:hover {
      background: #0056b3;
    }
/* âœ… ë¦¬ë·° ëª©ë¡ ë ˆì´ì•„ì›ƒ */
.review-container {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
      gap: 15px;
      margin-top: 30px;
    }
    .review-card {
      display: flex;
      align-items: center;
      background: white;
      padding: 15px;
      border-radius: 10px;
      box-shadow: 2px 2px 10px rgba(0, 0, 0, 0.1);
      transition: transform 0.2s ease-in-out;
    }
    .review-card:hover {
      transform: scale(1.02);
    }
    .review-image {
      width: 80px;
      height: 80px;
      border-radius: 8px;
      object-fit: cover;
      margin-right: 15px;
    }
    .review-content {
      text-align: left;
      flex: 1;
    }
    .review-title {
      font-size: 16px;
      font-weight: bold;
      color: #333;
    }
    .review-text {
      font-size: 14px;
      color: #666;
      margin: 5px 0;
    }
    .review-meta {
      font-size: 13px;
      color: #777;
    }
    .review-meta span {
      margin-right: 10px;
    }
    .review-star {
      color: #FFD700;
      font-weight: bold;
    }
    .btn {
      padding: 8px 15px;
      background: #007BFF;
      color: white;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      font-size: 14px;
      transition: background 0.2s;
    }
    .btn:hover {
      background: #0056b3;
    }
    .notification {
      position: fixed;
      top: 20px;
      right: 20px;
      background: #ff4d4d;
      color: white;
      padding: 10px;
      border-radius: 5px;
      z-index: 1000;
      display: none;
    }
    #loading { font-size: 18px; color: #555; display: none; }
    #error { color: red; font-size: 16px; display: none; }
    #ws-status { font-size: 14px; margin-top: 10px; color: #888; }

    /* âœ… ë¶€ì • ë¦¬ë·° ëª©ë¡ ìŠ¤íƒ€ì¼ */
    #negative-reviews {
      margin-top: 20px;
      text-align: left;
      width: 60%;
      margin: auto;
      padding: 10px;
      border: 1px solid #ddd;
      border-radius: 5px;
      background: #f8f8f8;
    }
    .review-item {
      padding: 8px;
      border-bottom: 1px solid #ddd;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .delete-btn {
      background: red;
      color: white;
      border: none;
      padding: 5px 10px;
      cursor: pointer;
    }
    .notification-popup {
    position: fixed;
    top: 20px;
    right: 20px;
    background: #ff4d4d;
    color: white;
    padding: 15px;
    border-radius: 5px;
    box-shadow: 2px 2px 10px rgba(0, 0, 0, 0.2);
    z-index: 1000;
    cursor: pointer;
    transition: opacity 0.3s ease-in-out;
    margin-bottom: 10px;
    }

    .notification-popup:hover {
        opacity: 0.8;
    }

  </style>
</head>
<body>
    <div class="container">
        <div class="title">ì¼ì£¼ì¼ í˜„í™© íŒŒì•… ë° ì´ìƒ ê°ì§€ ë¦¬ë·° ë¶„ì„ - <span id="today_date"></span></div>
        <div id="ws-status">ğŸ”Œ WebSocket ìƒíƒœ: ì—°ê²° ëŒ€ê¸° ì¤‘...</div>
    
        <h2>ì˜¤ëŠ˜ ê°ì„± ë¶„ì„</h2>
    <div class="chart-group">
    <div class="chart-box"><canvas id="todaySentimentChart"></canvas></div>
    <div class="bar-chart-box"><canvas id="todayCombinedCategoryChart"></canvas></div>
    <div class="chart-box">
        <canvas id="todayRatingAreaChart"></canvas>
    </div> <!-- ë ˆì´ë” ì°¨íŠ¸ ì¶”ê°€ -->
    </div>

    <h2>ì´ë²ˆ ì£¼ ê°ì„± ë¶„ì„</h2>
    <div class="chart-group">
    <div class="chart-box"><canvas id="weeklySentimentChart"></canvas></div>
    <div class="bar-chart-box"><canvas id="weeklyCombinedCategoryChart"></canvas></div>
    <div class="chart-box">
        <canvas id="weeklyRatingAreaChart"></canvas>
    </div> <!-- ë ˆì´ë” ì°¨íŠ¸ ì¶”ê°€ -->
    </div>

    
    <h2>ì´ìƒ ê°ì§€ ë¦¬ë·° ëª©ë¡</h2>
        <button class="toggle-btn" onclick="toggleAnomalyList('today')">ì˜¤ëŠ˜ ì´ìƒ ê°ì§€ ëª©ë¡</button>
        <button class="toggle-btn" onclick="toggleAnomalyList('weekly')">ì´ë²ˆ ì£¼ ì´ìƒ ê°ì§€ ëª©ë¡</button>

        <div id="today-anomaly-section" style="display: none;">
            <div id="today-anomaly-reviews" class="review-container"></div>
        </div>
    
        <div id="weekly-anomaly-section" style="display: none;">
            <div id="weekly-anomaly-reviews" class="review-container"></div>
        </div>
    </div>
    
    <!-- âœ… ë¦¬ë·° ìƒì„¸ë³´ê¸° ëª¨ë‹¬ -->
    <div id="reviewModal" style="display: none; position: fixed; top: 20%; left: 50%; transform: translate(-50%, -20%);
    width: 50%; max-height: 70%; background: white; padding: 20px; border-radius: 8px;
    box-shadow: 0 4px 10px rgba(0,0,0,0.2); overflow-y: auto;">
    <h3 id="modalTitle"></h3>
    <div id="modalReviewList" style="text-align: left; padding: 10px;"></div>
    <button onclick="closeModal()">ë‹«ê¸°</button>
</div>
    


  <div id="notification" class="notification"></div>

  <script>
    document.getElementById("today_date").innerText = new Date().toISOString().slice(0, 10);

    let socket;
    let reconnectAttempts = 0;  
    const maxReconnectAttempts = 10;
    let lastData = null;
    let lastAnomalyData = null;

    // âœ… APIì—ì„œ ë°ì´í„° ë¶ˆëŸ¬ì˜¤ê¸° ë° ì°¨íŠ¸ ê°±ì‹ 
// âœ… APIì—ì„œ ë°ì´í„° ë¶ˆëŸ¬ì˜¤ê¸° ë° ì°¨íŠ¸ ê°±ì‹ 
async function fetchAnomalySummary() {
    // âœ… ì „ì—­ ë³€ìˆ˜ë¡œ anomaly-summary ë°ì´í„° ì €ì¥
    try {
        console.log("ğŸ“¡ ë°ì´í„° ê°±ì‹  ìš”ì²­...");
        destroyAllCharts();

        const response = await fetch('/api/anomaly-summary');
        if (!response.ok) throw new Error(`HTTP error! Status: ${response.status}`);

        const data = await response.json();
        console.log("ğŸ“Š Anomaly Summary Data:", data);

        if (!data.today || !data.weekly) {
            throw new Error("âŒ ì´ìƒ ê°ì§€ ë°ì´í„°ê°€ ë¹„ì–´ ìˆìŒ");
        }
        // âœ… anomaly-summary ë°ì´í„°ë¥¼ ì „ì—­ ë³€ìˆ˜ì— ì €ì¥
        lastAnomalyData = data;

        console.log("ğŸ“Š ì˜¤ëŠ˜ ê°ì„± ë¶„ì„ ë°ì´í„°:", data.today.sentiment_analysis);
        console.log("âš ï¸ ì˜¤ëŠ˜ ì´ìƒ ê°ì§€ ë¦¬ë·° ê°œìˆ˜:", data.today.anomaly_reviews.length);
        console.log("ğŸ“Œ ì˜¤ëŠ˜ ë¶€ì • ë¦¬ë·° ê°œìˆ˜:", data.today.negative_reviews.length);

        updateDoughnutChart("todaySentimentChart", ["ë¶€ì •", "ì¤‘ë¦½", "ê¸ì •"], [
            data.today.sentiment_analysis?.[0] || 0,
            data.today.sentiment_analysis?.[1] || 0,
            data.today.sentiment_analysis?.[2] || 0
        ]);

        updateDoughnutChart("weeklySentimentChart", ["ë¶€ì •", "ì¤‘ë¦½", "ê¸ì •"], [
            data.weekly.sentiment_analysis?.[0] || 0,
            data.weekly.sentiment_analysis?.[1] || 0,
            data.weekly.sentiment_analysis?.[2] || 0
        ]);

        // âœ… ì¹´í…Œê³ ë¦¬ë³„ ê·¸ë˜í”„ ì—…ë°ì´íŠ¸ (ì¼ì¼ & ì£¼ê°„)
        const todayCategoryKeys = Object.keys(data.today.category_analysis || {}).sort();
        const weeklyCategoryKeys = Object.keys(data.weekly.category_analysis || {}).sort();

        console.log("ğŸ“Œ ì •ë ¬ëœ ì˜¤ëŠ˜ ì¹´í…Œê³ ë¦¬ í‚¤:", todayCategoryKeys);
        console.log("ğŸ“Œ ì£¼ê°„ ì¹´í…Œê³ ë¦¬ í‚¤:", weeklyCategoryKeys);
        console.log("ğŸ“Œ ì£¼ê°„ ì¹´í…Œê³ ë¦¬ ë°ì´í„°:", data.weekly.category_analysis);
        console.log("ğŸ“Œ ì£¼ê°„ ë¶€ì • ì¹´í…Œê³ ë¦¬ ë°ì´í„°:", data.weekly.negative_category_analysis);
        // ğŸš¨ ë¹ˆ ë°°ì—´ì´ë©´ ë¡œê·¸ ì¶œë ¥
        if (weeklyCategoryKeys.length === 0) {
            console.error("ğŸš¨ ì£¼ê°„ ì¹´í…Œê³ ë¦¬ í‚¤ê°€ ë¹„ì–´ ìˆìŒ. ë°ì´í„° ë¬¸ì œ í™•ì¸ í•„ìš”!");
        }



        // âœ… ì˜¤ëŠ˜ ì¹´í…Œê³ ë¦¬ë³„ ë°ì´í„° ì—…ë°ì´íŠ¸
        updateCombinedBarChart("todayCombinedCategoryChart",
            todayCategoryKeys,
            todayCategoryKeys.map(cat => data.today.category_analysis?.[cat] || 0),
            todayCategoryKeys.map(cat => data.today.negative_category_analysis?.[cat] || 0)
        );

        // âœ… ì´ë²ˆ ì£¼ ì¹´í…Œê³ ë¦¬ë³„ ë°ì´í„° ì—…ë°ì´íŠ¸ (ìˆœì„œ ì •ë ¬)
        updateCombinedBarChart("weeklyCombinedCategoryChart",
            weeklyCategoryKeys,
            weeklyCategoryKeys.map(cat => data.weekly.category_analysis?.[cat] ?? 0),
            weeklyCategoryKeys.map(cat => data.weekly.negative_category_analysis?.[cat] ?? 0)
        );





        updateStackedAreaChart(
            "todayRatingAreaChart",
            ["â­ 1ì ", "â­ 2ì ", "â­ 3ì ", "â­ 4ì ", "â­ 5ì "],
            [{
                label: "ì˜¤ëŠ˜ í‰ì  ë¶„í¬",
                data: [
                    data.today.rating_distribution?.[1] || 0,
                    data.today.rating_distribution?.[2] || 0,
                    data.today.rating_distribution?.[3] || 0,
                    data.today.rating_distribution?.[4] || 0,
                    data.today.rating_distribution?.[5] || 0
                ],
                backgroundColor: "rgba(54, 162, 235, 0.5)",
                borderColor: "rgba(54, 162, 235, 1)",
                fill: true
            }]
        );

        updateStackedAreaChart(
            "weeklyRatingAreaChart",
            ["â­ 1ì ", "â­ 2ì ", "â­ 3ì ", "â­ 4ì ", "â­ 5ì "],
            [{
                label: "ì´ë²ˆ ì£¼ í‰ì  ë¶„í¬",
                data: [
                    data.weekly.rating_distribution?.[1] || 0,
                    data.weekly.rating_distribution?.[2] || 0,
                    data.weekly.rating_distribution?.[3] || 0,
                    data.weekly.rating_distribution?.[4] || 0,
                    data.weekly.rating_distribution?.[5] || 0
                ],
                backgroundColor: "rgba(255, 99, 132, 0.5)",
                borderColor: "rgba(255, 99, 132, 1)",
                fill: true
            }]
        );


        console.log("ğŸ“Œ ì˜¤ëŠ˜ ì´ìƒ ê°ì§€ ëª©ë¡:", data.today.anomaly_reviews);
        console.log("ğŸ“Œ ì´ë²ˆ ì£¼ ì´ìƒ ê°ì§€ ëª©ë¡:", data.weekly.anomaly_reviews);

        // âœ… ì˜¤ëŠ˜ ì´ìƒ ê°ì§€ ë¦¬ë·° ì—…ë°ì´íŠ¸
        updateAnomalyReviews("today-anomaly-reviews", data.today.anomaly_reviews || []);

        // âœ… ì´ë²ˆ ì£¼ ì´ìƒ ê°ì§€ ë¦¬ë·° ì—…ë°ì´íŠ¸
        updateAnomalyReviews("weekly-anomaly-reviews", data.weekly.anomaly_reviews || []);

    } catch (error) {
        console.error("ğŸš¨ Error fetching anomaly summary:", error);
    }
}




    function updateNegativeReviews(reviews) {
        const reviewList = document.getElementById("negative-reviews");
        reviewList.innerHTML = "";

        reviews.forEach(review => {
            const listItem = document.createElement("li");
            listItem.innerHTML = `<span><strong>${review.category}</strong>: ${review.sentence}</span>`;
            reviewList.appendChild(listItem);
        });
    }

    // âœ… ì „ì—­ ì°¨íŠ¸ ì¸ìŠ¤í„´ìŠ¤ ì €ì¥ ë³€ìˆ˜
let chartInstances = {};

// âœ… ê¸°ì¡´ ì°¨íŠ¸ë¥¼ ì‚­ì œí•˜ëŠ” í•¨ìˆ˜
function destroyAllCharts() {
    for (const canvasId in chartInstances) {
        if (chartInstances[canvasId]) {
            console.log(`ğŸ—‘ï¸ ê¸°ì¡´ ì°¨íŠ¸ ì‚­ì œë¨: ${canvasId}`);
            chartInstances[canvasId].destroy();  // âœ… ê¸°ì¡´ ì°¨íŠ¸ ì™„ì „ ì‚­ì œ
            delete chartInstances[canvasId];  // âœ… ë©”ëª¨ë¦¬ í•´ì œ
        }
    }
}

// âœ… ì°¨íŠ¸ë¥¼ ì—…ë°ì´íŠ¸í•˜ê¸° ì „ì— ê¸°ì¡´ ì°¨íŠ¸ ì œê±°
// âœ… ì›í˜• ê·¸ë˜í”„ ì—…ë°ì´íŠ¸
function updateDoughnutChart(canvasId, labels, data) {
    const canvas = document.getElementById(canvasId);
    if (!canvas) return;

    const ctx = canvas.getContext('2d');
    if (chartInstances[canvasId]) {
        chartInstances[canvasId].destroy();
    }

    chartInstances[canvasId] = new Chart(ctx, {
        type: 'doughnut',
        data: {
            labels,
            datasets: [{
                data,
                backgroundColor: ['#ff4d4d', '#ffc107', '#17a2b8']
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: { display: true, position: 'top' },
                datalabels: {
                    color: '#fff', // âœ… í¼ì„¼íŠ¸ ê¸€ì”¨ ìƒ‰ìƒ (í°ìƒ‰)
                    font: { weight: 'bold', size: 14 }, // âœ… ê¸€ì”¨ í¬ê¸° ì¡°ì •
                    formatter: (value, context) => {
                        const dataset = context.dataset.data;
                        const total = dataset.reduce((acc, num) => acc + num, 0);
                        if (total === 0) return ""; // âœ… ê°’ì´ 0ì´ë©´ í‘œì‹œ ì•ˆ í•¨
                        const percentage = ((value / total) * 100).toFixed(1);
                        return `${percentage}%`; // âœ… í¼ì„¼íŠ¸ ê°’ í‘œì‹œ
                    }
                }
            }
        },
        plugins: [ChartDataLabels] // âœ… í”ŒëŸ¬ê·¸ì¸ í™œì„±í™” (í¼ì„¼íŠ¸ í‘œì‹œ)
    });
}

// âœ… ì œí’ˆ ë¦¬ìŠ¤íŠ¸ë§Œ í‘œì‹œ & ë¦¬ë·° ìƒì„¸ë³´ê¸° ë²„íŠ¼ ì¶”ê°€
function updateAnomalyReviews(listId, reviews) {
    const reviewList = document.getElementById(listId);
    reviewList.innerHTML = "";  // âœ… ê¸°ì¡´ ë‚´ìš©ì„ ì§€ìš°ê³  ìƒˆë¡œ ì—…ë°ì´íŠ¸

    if (!reviews || reviews.length === 0) {
        reviewList.innerHTML = "<p>ì´ìƒ ê°ì§€ëœ ë¦¬ë·°ê°€ ì—†ìŠµë‹ˆë‹¤.</p>";
        return;
    }

    // âœ… ì œí’ˆë³„ë¡œ ê·¸ë£¹í™”í•˜ì—¬ ì¤‘ë³µ ë¦¬ë·° ë°©ì§€
    const groupedReviews = reviews.reduce((acc, review) => {
        if (!acc[review.product_id]) {
            acc[review.product_id] = {
                product_id: review.product_id,
                product_name: review.product_name,
                brand: review.brand,
                price: review.price,
                image_url: review.image_url,
                reviews: [],
                total_reviews: 0
            };
        }
        acc[review.product_id].reviews.push(review);
        acc[review.product_id].total_reviews += 1;
        return acc;
    }, {});

    Object.values(groupedReviews).forEach(product => {
        const reviewCard = document.createElement("div");
        reviewCard.classList.add("review-card");
        reviewCard.setAttribute("data-product-id", String(product.product_id || ""));

        const imageHTML = product.image_url 
            ? `<img src="${product.image_url}" alt="ì œí’ˆ ì´ë¯¸ì§€" class="review-image">` 
            : '';

        reviewCard.innerHTML = `
            ${imageHTML}
            <div class="review-content">
                <div class="review-title" style="cursor: pointer; text-decoration: underline;">
                    ${product.product_name} (${product.brand}) - ${product.price || "ê°€ê²© ì •ë³´ ì—†ìŒ"}
                </div>
                <div class="review-meta">
                    <span>ğŸ“Œ <strong>ì´ ë¦¬ë·°:</strong> ${product.total_reviews}ê°œ</span>
                    <button class="btn review-btn"
                        data-product-id="${String(product.product_id || '')}"
                        data-product-name="${encodeURIComponent(product.product_name)}"
                        data-section="${listId}">
                        ìƒì„¸ë³´ê¸°
                    </button>
                </div>
            </div>
        `;

        reviewList.appendChild(reviewCard);
    });


    // âœ… "ìƒì„¸ë³´ê¸°" ë²„íŠ¼ í´ë¦­ ì‹œ ë¦¬ë·° ìƒì„¸ë³´ê¸° ëª¨ë‹¬ ë„ìš°ê¸° (ì´ë²¤íŠ¸ ìœ„ì„ ì ìš©)
    document.body.addEventListener("click", function(event) {
    if (event.target.classList.contains("review-btn")) {
        event.stopPropagation();

        const productId = event.target.getAttribute("data-product-id");
        const productName = event.target.getAttribute("data-product-name");
        const section = event.target.getAttribute("data-section");

        if (!productId) {
            console.warn("âš ï¸ product_idê°€ ìœ íš¨í•˜ì§€ ì•ŠìŒ:", productId);
            return;
        }

        console.log(`ğŸ” ìƒì„¸ë³´ê¸° ì‹¤í–‰: ${productName} (ID: ${productId})`);
        showReviewModal(productName, productId, section);
    }
});



// âœ… ì¹´ë“œ í´ë¦­ ì‹œ ê°•/ì•½ì  ë¶„ì„ í˜ì´ì§€ë¡œ ì´ë™ (ìƒì„¸ë³´ê¸° ë²„íŠ¼ í´ë¦­ ì œì™¸)
document.body.addEventListener("click", function(event) {
    const reviewCard = event.target.closest(".review-card");

    if (reviewCard && !event.target.classList.contains("review-btn")) {
        const productId = reviewCard.getAttribute("data-product-id");

        if (productId) {
            console.log(`ğŸ” ê°•/ì•½ì  ë¶„ì„ í˜ì´ì§€ ì´ë™: productId=${productId}`);
            window.location.href = `/strength-weakness.html?product_id=${productId}`;
        }
    }
});

// âœ… ë¦¬ë·° ìƒì„¸ë³´ê¸° ëª¨ë‹¬ ì—´ê¸°
function showReviewModal(productName, productId, section) {
    console.log(`ğŸ“¢ ìƒì„¸ë³´ê¸° ì‹¤í–‰: ${productName} (ID: ${productId}), Section: ${section}`);

    if (!productId) {
        console.warn("âš ï¸ product_idê°€ ì˜¬ë°”ë¥´ì§€ ì•ŠìŒ:", productId);
        return;
    }

    const modal = document.getElementById("reviewModal");
    const modalTitle = document.getElementById("modalTitle");
    const reviewList = document.getElementById("modalReviewList");

    // âœ… URL ë””ì½”ë”© ì¶”ê°€í•˜ì—¬ ì •ìƒì ì¸ ì œí’ˆëª… í‘œì‹œ
    const decodedProductName = decodeURIComponent(productName);
    modalTitle.innerText = `ğŸ“Œ ${decodedProductName} - ë¦¬ë·° ìƒì„¸ë³´ê¸°`;
    reviewList.innerHTML = "<p>ë¦¬ë·° ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</p>";

    if (!lastAnomalyData) {
        reviewList.innerHTML = "<p>âš ï¸ ë¦¬ë·° ë°ì´í„°ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</p>";
        return;
    }

    let productReviews = [];

    // âœ… ì„ íƒí•œ ì„¹ì…˜(today/weekly)ì— ë”°ë¼ ë¦¬ë·° í•„í„°ë§
    if (section === "today-anomaly-reviews") {
        productReviews = lastAnomalyData.today.anomaly_reviews.filter(review => review.product_id === productId);
    } else if (section === "weekly-anomaly-reviews") {
        productReviews = lastAnomalyData.weekly.anomaly_reviews.filter(review => review.product_id === productId);
    }

    if (productReviews.length === 0) {
        reviewList.innerHTML = "<p>ë¦¬ë·° ì—†ìŒ</p>";
        return;
    }

    reviewList.innerHTML = "";

    productReviews.forEach(review => {
        const formattedDate = review.review_date ? review.review_date.split(" ")[0] : "ë‚ ì§œ ì—†ìŒ";

        let sentimentLabel = "";
        let sentimentColor = "";
        if (review.sentiment === 0) {
            sentimentLabel = "ë¶€ì • ê°ì„± ğŸ”´";
            sentimentColor = "red";
        } else if (review.sentiment === 1) {
            sentimentLabel = "ì¤‘ë¦½ ê°ì„± ğŸŸ¡";
            sentimentColor = "orange";
        } else if (review.sentiment === 2) {
            sentimentLabel = "ê¸ì • ê°ì„± ğŸŸ¢";
            sentimentColor = "green";
        }

        const listItem = document.createElement("div");
        listItem.style.marginBottom = "10px";
        listItem.style.padding = "10px";
        listItem.style.borderBottom = "1px solid #ddd";

        listItem.innerHTML = `
            â­ <strong>ë³„ì :</strong> ${review.rating || "N/A"}ì <br>
            ğŸ“ <strong>ë¦¬ë·°:</strong> ${review.sentence ? review.sentence : "ë‚´ìš© ì—†ìŒ"}<br>
            ğŸ“ <strong>ì‚¬ì´ì¦ˆ:</strong> ${review.review_size ? review.review_size : "ë¯¸ì§€ì •"}<br>
            ğŸ“… <strong>ì‘ì„±ì¼:</strong> ${formattedDate}<br>
            ğŸ” <strong>ê°ì„± ë¶„ì„:</strong> <span style="color: ${sentimentColor}; font-weight: bold;">${sentimentLabel}</span>
        `;

        reviewList.appendChild(listItem);
    });

    modal.style.display = "block";
}
}

// âœ… ëª¨ë‹¬ ì°½ ë‹«ê¸°
function closeModal() {
    document.getElementById("reviewModal").style.display = "none";
    document.getElementById("modalReviewList").innerHTML = ""; // âœ… ëª¨ë‹¬ ë‹«ì„ ë•Œ ë‚´ìš© ì´ˆê¸°í™”
}





// âœ… ê°•/ì•½ì  ë¶„ì„ í˜ì´ì§€ë¡œ ì´ë™í•˜ëŠ” í•¨ìˆ˜
function redirectToStrengthWeakness(productId) {
    window.location.href = `/strength-weakness.html?product_id=${productId}`;
}


// âœ… ëª¨ë‹¬ ì°½ ë‹«ê¸°
function closeModal() {
    document.getElementById("reviewModal").style.display = "none";
}

// âœ… ì¹´í…Œê³ ë¦¬ë³„ ë§‰ëŒ€ ê·¸ë˜í”„ (ì „ì²´ + ë¶€ì • ë¦¬ë·° í†µí•©)
function updateCombinedBarChart(canvasId, labels, totalData, negativeData) {
    const canvas = document.getElementById(canvasId);
    if (!canvas) return;

    const ctx = canvas.getContext('2d');
    if (chartInstances[canvasId]) {
        chartInstances[canvasId].destroy();
    }

    // âœ… ë°ì´í„° ê¸¸ì´ ë””ë²„ê¹… ë¡œê·¸ ì¶”ê°€
    console.log(`ğŸ“Š ${canvasId} ê·¸ë˜í”„ ë°ì´í„°`);
    console.log("ğŸ“Œ ì¹´í…Œê³ ë¦¬:", labels);
    console.log("ğŸ“Œ ì „ì²´ ë¦¬ë·° ë°ì´í„° ê¸¸ì´:", totalData.length);
    console.log("ğŸ“Œ ë¶€ì • ë¦¬ë·° ë°ì´í„° ê¸¸ì´:", negativeData.length);

    chartInstances[canvasId] = new Chart(ctx, {
        type: 'bar',
        data: {
            labels,
            datasets: [
                { label: "ì „ì²´ ë¦¬ë·°", data: totalData, backgroundColor: '#36a2eb' },
                { label: "ë¶€ì • ë¦¬ë·°", data: negativeData, backgroundColor: '#ff4d4d' }
            ]
        },
        options: { responsive: true, indexAxis: 'y' }
    });
}
    // âœ… ë ˆì´ë” ì°¨íŠ¸ ì—…ë°ì´íŠ¸ í•¨ìˆ˜
    function updateStackedAreaChart(canvasId, labels, dataset) {
    const canvas = document.getElementById(canvasId);
    if (!canvas) {
        console.warn(`âš ï¸ ìº”ë²„ìŠ¤ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŒ: ${canvasId}`);
        return;
    }

    const ctx = canvas.getContext('2d');

    if (chartInstances[canvasId]) {
        chartInstances[canvasId].destroy();
    }

    chartInstances[canvasId] = new Chart(ctx, {
        type: 'line',
        data: {
            labels: labels,
            datasets: dataset
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                y: {
                    stacked: true,  // âœ… í™•ì‹¤í•˜ê²Œ ì ìš©
                    beginAtZero: true // âœ… ê°’ì´ 0ë¶€í„° ì‹œì‘í•˜ë„ë¡ ì„¤ì •
                }
            },
            plugins: {
                legend: { display: true, position: 'top' }
            }
        }
    });
}




function toggleAnomalyList(type) {
          document.getElementById("today-anomaly-section").style.display = type === "today" ? "block" : "none";
          document.getElementById("weekly-anomaly-section").style.display = type === "weekly" ? "block" : "none";
      }


function showNotification(message, review) {
    const notification = document.createElement("div");
    notification.classList.add("notification-popup");

    // âœ… ì´ìƒ ê°ì§€ ìœ í˜• íŒë³„
    let anomalyType = "";
    if (review.sentiment === 0 && (review.rating === 4.0 || review.rating === 5.0)) {
        anomalyType = "ğŸ”´ [ë¶€ì • ê°ì„± ê°ì§€]";
    } else if (review.rating === 1.0 || review.rating === 2.0) {
        anomalyType = "ğŸŸ  [í‰ì  ê°ì§€]";
    } else {
        anomalyType = "âš ï¸ [ì¼ë°˜ ë¶€ì • ê°ì§€]";
    }

    notification.innerHTML = `
        <strong>${message}</strong><br>
        <span>[${review.category}] ${review.sentence}</span><br>
        <small style="color: yellow;">${anomalyType} | í‰ì : ${review.rating}</small>
    `;

    notification.onclick = () => notification.remove();

    let notificationContainer = document.getElementById("notification-container");
    if (!notificationContainer) {
        notificationContainer = document.createElement("div");
        notificationContainer.id = "notification-container";
        notificationContainer.style.position = "fixed";
        notificationContainer.style.top = "20px";
        notificationContainer.style.right = "20px";
        notificationContainer.style.display = "flex";
        notificationContainer.style.flexDirection = "column";
        notificationContainer.style.gap = "10px";
        notificationContainer.style.zIndex = "1000";
        document.body.appendChild(notificationContainer);
    }

    notificationContainer.appendChild(notification);
}


    function connectWebSocket() {
        const wsUrl = `ws://${window.location.host}/ws`;
        socket = new WebSocket(wsUrl);

        socket.onopen = () => {
            console.log("âœ… WebSocket ì—°ê²° ì„±ê³µ");
            document.getElementById("ws-status").innerText = "âœ… WebSocket ì—°ê²°ë¨";
        };

        socket.onmessage = (event) => {
            console.log("ğŸ“¡ WebSocket ë©”ì‹œì§€ ìˆ˜ì‹ :", event.data);
            const data = JSON.parse(event.data);

            if (data.alert) {
                console.log("ğŸ“¢ ì•Œë¦¼ ìˆ˜ì‹ :", data.alert, data.review);
                showNotification(data.alert, data.review);

                // âœ… ì´ìƒ ê°ì§€ ë¦¬ìŠ¤íŠ¸ ì—…ë°ì´íŠ¸
                fetchAnomalySummary();
            }
        };

        socket.onclose = () => {
            console.warn("âš ï¸ WebSocket ì—°ê²° ì¢…ë£Œë¨");
            document.getElementById("ws-status").innerText = `âš ï¸ WebSocket ì—°ê²° í•´ì œë¨`;
            setTimeout(connectWebSocket, 3000);
        };
    }

    document.addEventListener("DOMContentLoaded", () => {
    const todayDateElement = document.getElementById("today_date");
    if (todayDateElement) {
        todayDateElement.innerText = new Date().toISOString().slice(0, 10);
    } else {
        console.warn("âš ï¸ today_date ìš”ì†Œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
    }

    connectWebSocket();
    fetchAnomalySummary();
    setInterval(fetchAnomalySummary, 30000);
});
  </script>
</body>
</html>